name: Update Vendor

on:
  workflow_dispatch:
  schedule:
  # At 13:37 UTC every day.
  - cron: '37 13 * * *'

defaults:
  run:
    shell: pwsh

permissions:
  contents: read

jobs:
  vendor:

    runs-on: windows-latest
    continue-on-error: false
    timeout-minutes: 15
    permissions:
      contents: write
      pull-requests: write

    steps:
    - uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - name: Summary - Workflow started
      shell: pwsh
      run: |
        $summary = @(
          '## üì¶ Update Vendor - Workflow Summary'
          ''
          'üîç Checking for vendor dependency updates...'
          ''
        )
        $summary | Add-Content -Path $env:GITHUB_STEP_SUMMARY -Encoding utf8

    - id: make-changes
      name: Checking for updates
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
          $currentVersion = (Get-Content .\vendor\sources.json | ConvertFrom-Json)
          . .\scripts\update.ps1 -verbose

          # Export count of updated packages (update.ps1 is expected to set $count)
          if (-not ($count)) { $count = 0 }
          Add-Content -Path $env:GITHUB_ENV -Value ("COUNT_UPDATED=$count")

          $newVersion = (Get-Content .\vendor\sources.json | ConvertFrom-Json)
          $listUpdated = ""
          $updateMessage = "| Name | Old Version | New Version |`n| :--- | :---: | :---: |`n"
          $majorUpdates = @()
          $singleDepName = ""
          $singleDepOldVersion = ""
          $singleDepNewVersion = ""
          foreach ($s in $newVersion) {
            $oldVersion = ($currentVersion | Where-Object {$_.name -eq $s.name}).version
            if ($s.version -ne $oldVersion) {
              $repoUrl = ($repoUrl = $s.Url.Replace("/archive/", "/releases/")).Substring(0, $repoUrl.IndexOf("/releases/")) + "/releases"

              if ($count -eq 1) {
                $singleDepName = $s.name
                $singleDepOldVersion = $oldVersion
                $singleDepNewVersion = $s.version
              }

              $changeType = "unknown"
              $emoji = "üîÑ"
              $isMajor = $false
              try {
                $oldVerStr = $oldVersion.Split('-')[0]
                $newVerStr = $s.version.Split('-')[0]
                $oldParts = $oldVerStr.Split('.') | Where-Object { $_ -match '^\d+$' } | Select-Object -First 4
                $newParts = $newVerStr.Split('.') | Where-Object { $_ -match '^\d+$' } | Select-Object -First 4

                if ($oldParts.Count -ge 2 -and $newParts.Count -ge 2) {
                  $oldVerParseable = $oldParts -join '.'
                  $newVerParseable = $newParts -join '.'
                  $oldVer = [System.Version]::Parse($oldVerParseable)
                  $newVer = [System.Version]::Parse($newVerParseable)

                  if ($newVer.Major -gt $oldVer.Major) {
                    $changeType = "major"
                    $emoji = "üî•"
                    $isMajor = $true
                  } elseif ($newVer.Minor -gt $oldVer.Minor) {
                    $changeType = "minor"
                    $emoji = "üöÄ"
                  } else {
                    $changeType = "patch"
                    $emoji = "‚¨ÜÔ∏è"
                  }
                }
              } catch {
                $changeType = "unknown"
                $emoji = "üîÑ"
              }

              if ($isMajor) {
                $compareUrl = "$repoUrl/compare/v$oldVersion...v$($s.version)"
                $majorUpdates += @{
                  name = $s.name
                  oldVersion = $oldVersion
                  newVersion = $s.version
                  compareUrl = $compareUrl
                  repoUrl = $repoUrl
                }
              }

              $listUpdated += "$($s.name) v$($s.version), "
              $updateMessage += "| $emoji **[$($s.name)]($repoUrl)** | \`$oldVersion\` | **\`$($s.version)\`** |`n"
            }
          }

          if ($count -eq 0) { return }

          Add-Content -Path $env:GITHUB_ENV -Value ("LIST_UPDATED=" + $listUpdated.Trim(', '))

          if ([string]::IsNullOrEmpty($singleDepName) -and $count -eq 1) {
            Write-Warning "Single dependency name not set despite count being 1"
            $singleDepName = "unknown-package"
            $singleDepOldVersion = "unknown"
            $singleDepNewVersion = "unknown"
          } elseif ([string]::IsNullOrEmpty($singleDepName)) {
            $singleDepName = ""
            $singleDepOldVersion = ""
            $singleDepNewVersion = ""
          }

          Add-Content -Path $env:GITHUB_ENV -Value ("SINGLE_DEP_NAME=" + $singleDepName)
          Add-Content -Path $env:GITHUB_ENV -Value ("SINGLE_DEP_OLD_VERSION=" + $singleDepOldVersion)
          Add-Content -Path $env:GITHUB_ENV -Value ("SINGLE_DEP_NEW_VERSION=" + $singleDepNewVersion)

          # Write multiline UPDATE_MESSAGE to GITHUB_ENV
          Add-Content -Path $env:GITHUB_ENV -Value "UPDATE_MESSAGE<<EOF"
          Add-Content -Path $env:GITHUB_ENV -Value $updateMessage
          Add-Content -Path $env:GITHUB_ENV -Value "EOF"

          # Generate major updates changelog section and export
          if ($majorUpdates.Count -gt 0) {
            $changelogSection = "`n<details>`n<summary>üî• Major version updates - View changelog</summary>`n`n"
            foreach ($update in $majorUpdates) {
              $changelogSection += "### [$($update.name)]($($update.repoUrl))`n"
              $changelogSection += "**$($update.oldVersion)** ‚Üí **$($update.newVersion)**`n`n"
              $changelogSection += "- [View full changelog]($($update.compareUrl))`n"
              $changelogSection += "- [Release notes]($($update.repoUrl)/tag/v$($update.newVersion))`n`n"
            }
            $changelogSection += "</details>`n"

            Add-Content -Path $env:GITHUB_ENV -Value "CHANGELOG_SECTION<<EOF"
            Add-Content -Path $env:GITHUB_ENV -Value $changelogSection
            Add-Content -Path $env:GITHUB_ENV -Value "EOF"
            Add-Content -Path $env:GITHUB_ENV -Value "HAS_BREAKING_CHANGES=True"
          } else {
            Add-Content -Path $env:GITHUB_ENV -Value "CHANGELOG_SECTION="
            Add-Content -Path $env:GITHUB_ENV -Value "HAS_BREAKING_CHANGES=False"
          }

    - name: Summary - Update check results
      shell: pwsh
      run: |
        $count = [int]$env:COUNT_UPDATED

        if ($count -eq 0) {
          $summary = @(
          '### ‚úÖ No Updates Available'
          ''
          'All vendor dependencies are up to date! üéâ'
          ''
          )
        } else {
          $word = if ($count -eq 1) { 'dependency' } else { 'dependencies' }
          $summary = @(
          '### üîÑ Updates Found'
          ''
          )
          $summary += 'üì¶ **' + $env:SINGLE_DEP_NAME + '** updated from `' + $env:SINGLE_DEP_OLD_VERSION + '` to `' + $env:SINGLE_DEP_NEW_VERSION + '`' + [Environment]::NewLine + [Environment]::NewLine
          $summary += 'üì¶ **' + $count + '** vendor ' + $word + ' updated:' + [Environment]::NewLine + [Environment]::NewLine
        }

        $summary += $env:UPDATE_MESSAGE + [Environment]::NewLine

        # Check if we can auto-merge (only minor/patch changes)
        $hasBreaking = $env:HAS_BREAKING_CHANGES -eq 'True'
        if ($hasBreaking) {
          $summary += '> ‚ö†Ô∏è **Note:** This update contains major version changes that may include breaking changes.'
        } else {
          $summary += '> ‚ÑπÔ∏è **Note:** This update only contains minor or patch changes.'
        }

        $summary | Add-Content -Path $env:GITHUB_STEP_SUMMARY -Encoding utf8

    - name: Auto-merge minor updates
      if: env.COUNT_UPDATED > 0 && env.HAS_BREAKING_CHANGES != 'True'
      shell: pwsh
      run: |
        try {
          echo "### üöÄ Auto-merging Updates" >> $env:GITHUB_STEP_SUMMARY
          echo "" >> $env:GITHUB_STEP_SUMMARY
          echo "Attempting to automatically merge non-breaking changes to main..." >> $env:GITHUB_STEP_SUMMARY

          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # Commit the changes
          git add vendor/sources.json
          $commitResult = git commit -m "‚¨ÜÔ∏è Update dependencies ($env:LIST_UPDATED)"

          # Push directly to main
          git push origin HEAD:main

          echo "" >> $env:GITHUB_STEP_SUMMARY
          echo "‚úÖ **Success!** Updates have been automatically merged to main." >> $env:GITHUB_STEP_SUMMARY
          echo "" >> $env:GITHUB_STEP_SUMMARY
          echo "**Updated dependencies:** $env:LIST_UPDATED" >> $env:GITHUB_STEP_SUMMARY

          # Set a flag to skip PR creation
          echo "AUTO_MERGED=true" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
        } catch {
          echo "" >> $env:GITHUB_STEP_SUMMARY
          echo "‚ö†Ô∏è **Warning:** Unable to automatically merge updates." >> $env:GITHUB_STEP_SUMMARY
          echo "" >> $env:GITHUB_STEP_SUMMARY
          echo "**Error:** $($_.Exception.Message)" >> $env:GITHUB_STEP_SUMMARY
          echo "" >> $env:GITHUB_STEP_SUMMARY
          echo "Falling back to creating a pull request..." >> $env:GITHUB_STEP_SUMMARY

          Write-Warning "Failed to auto-merge: $($_.Exception.Message)"

          # Reset the commit if one was made
          if ($commitResult) {
            git reset --hard HEAD~1
          }

          # Set flag to create PR instead
          echo "AUTO_MERGED=false" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
        }

    - uses: peter-evans/create-pull-request@v8
      if: env.COUNT_UPDATED > 0 && (env.HAS_BREAKING_CHANGES == 'True' || env.AUTO_MERGED == 'false')
      with:
        title: ${{ env.COUNT_UPDATED == '1' && format('‚¨ÜÔ∏è Update {0}', env.LIST_UPDATED) || format('‚¨ÜÔ∏è Update {0} vendored dependencies', env.COUNT_UPDATED) }}
        body: |
          ### ${{ env.COUNT_UPDATED == 1 && format('üì¶ Updated {0} from `{1}` to `{2}`', env.SINGLE_DEP_NAME, env.SINGLE_DEP_OLD_VERSION, env.SINGLE_DEP_NEW_VERSION) || format('üì¶ Automatically updated `{0}` dependencies', env.COUNT_UPDATED) }}

          ${{ env.UPDATE_MESSAGE }}

          ${{ env.CHANGELOG_SECTION }}

          ---

          ${{ env.HAS_BREAKING_CHANGES == 'True' && '‚ö†Ô∏è **This update contains major version changes that may include breaking changes.**' || '‚ÑπÔ∏è This update only contains minor or patch changes.' }}

          Please verify and then **Merge** the pull request to apply the updates.
        commit-message: '‚¨ÜÔ∏è Update dependencies (${{ env.LIST_UPDATED }})'
        branch: update-vendor
        base: main

    - name: Summary - Pull request created
      if: env.COUNT_UPDATED > 0 && (env.HAS_BREAKING_CHANGES == 'True' || env.AUTO_MERGED == 'false')
      shell: pwsh
      run: |
        $updatedLine = if (-not [string]::IsNullOrEmpty($env:LIST_UPDATED)) { "**Updated dependencies:** $env:LIST_UPDATED" } else { "**Updated dependencies:** " }
        $summary = @"
        ### üéâ Pull Request Created

        A pull request has been created to update the vendor dependencies.

        **Branch:** `update-vendor`

        $updatedLine

        "@

        if ($env:HAS_BREAKING_CHANGES -eq 'True') {
          $summary += "> ‚ö†Ô∏è **Manual review required:** This update contains major version changes."
        } else {
          $summary += "> ‚ÑπÔ∏è **Note:** Auto-merge failed, manual review required."
        }

        $summary += @"
        > Please review and merge the pull request to apply the updates.

        "@

        $summary | Add-Content -Path $env:GITHUB_STEP_SUMMARY -Encoding utf8
